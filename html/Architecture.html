<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RAG Chatbot - Detailed Low-Level Architecture</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
    .container { max-width: 1200px; margin: 40px auto; background: #fff; padding: 32px 40px 40px 40px; border-radius: 12px; box-shadow: 0 4px 24px #0001; }
    h1 { color: #2a4d7a; }
    h2 { color: #3b7a57; }
    .diagram { text-align: center; margin: 40px 0; }
    .legend { font-size: 0.95em; color: #555; margin-bottom: 24px; }
    .step { margin-bottom: 18px; }
    code { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; }
    .box { display: inline-block; background: #e3eefd; border: 1px solid #b3c6e7; border-radius: 8px; padding: 10px 18px; margin: 8px; font-weight: bold; }
    .arrow { font-size: 2em; vertical-align: middle; margin: 0 10px; color: #888; }
    .note { background: #fffbe6; border-left: 4px solid #ffe066; padding: 10px 18px; margin: 24px 0; border-radius: 6px; }
    .sub { font-size: 0.95em; color: #666; }
    @media (max-width: 700px) {
      .container { padding: 12px; }
      .diagram { font-size: 0.85em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>RAG Chatbot - Detailed Low-Level Architecture</h1>
    <div class="legend">
      <b>Technologies:</b> AWS Lambda, Amazon S3, AWS Bedrock, Pinecone, DynamoDB, API Gateway, CloudWatch, IAM, VPC, Cohere Embeddings, Claude (Anthropic), Python
    </div>

    <h2>Low-Level Architecture Diagram</h2>
    <div class="diagram">
      <div>
        <span class="box" style="background:#ffe0e0;">S3 Bucket<br><small>Raw Docs, PDFs, HTML</small></span>
        <span class="arrow">&#8594;</span>
        <span class="box" style="background:#e0ffe0;">Lambda: Preprocessing<br><span class="sub">Triggered by S3 Event or Manual</span></span>
        <span class="arrow">&#8594;</span>
        <span class="box" style="background:#e0e7ff;">Pinecone<br><small>Vector DB<br>Chunks + Embeddings</small></span>
      </div>
      <div style="margin: 10px 0;">
        <span class="arrow" style="transform: rotate(90deg);">&#8595;</span>
      </div>
      <div>
        <span class="box" style="background:#fffbe0;">User<br><small>Web UI / API Client</small></span>
        <span class="arrow">&#8594;</span>
        <span class="box" style="background:#e0f7ff;">API Gateway<br><small>REST/HTTP Endpoint</small></span>
        <span class="arrow">&#8594;</span>
        <span class="box" style="background:#e0ffe0;">Lambda: Chatbot Handler<br><span class="sub">Embed, Retrieve, LLM, History</span></span>
        <span class="arrow">&#8594;</span>
        <span class="box" style="background:#e0ffe7;">AWS Bedrock<br><small>Cohere & Claude</small></span>
      </div>
      <div style="margin: 10px 0;">
        <span class="arrow" style="transform: rotate(90deg);">&#8595;</span>
      </div>
      <div>
        <span class="box" style="background:#e0f7ff;">DynamoDB<br><small>Conversation History</small></span>
      </div>
      <div style="margin: 10px 0;">
        <span class="arrow" style="transform: rotate(90deg);">&#8595;</span>
      </div>
      <div>
        <span class="box" style="background:#e0e0e0;">CloudWatch<br><small>Logs & Metrics</small></span>
        <span class="arrow">&#8594;</span>
        <span class="box" style="background:#e0e0ff;">IAM Roles<br><small>Lambda Permissions</small></span>
      </div>
      <div style="margin: 10px 0;">
        <span class="arrow" style="transform: rotate(90deg);">&#8595;</span>
      </div>
      <div>
        <span class="box" style="background:#e0ffe0;">VPC (Optional)<br><small>Private Networking</small></span>
      </div>
    </div>

    <h2>Detailed Step-by-Step Data Flow</h2>
    <div class="step"><b>1. Document Upload:</b> Documents (text, PDFs, HTML, etc.) are uploaded to an <b>Amazon S3 bucket</b>.</div>
    <div class="step"><b>2. Preprocessing Lambda:</b> Triggered by S3 event or manually. Reads files, chunks and cleans text, generates embeddings via <b>Cohere (Bedrock)</b>, and upserts to <b>Pinecone</b>.</div>
    <div class="step"><b>3. User Query:</b> User interacts via a Web UI or API client, sending a question to <b>API Gateway</b>.</div>
    <div class="step"><b>4. API Gateway:</b> Forwards the request to the <b>Chatbot Lambda</b> function.</div>
    <div class="step"><b>5. Chatbot Lambda:</b> 
      <ul>
        <li>Generates embedding for the user query using <b>Cohere (Bedrock)</b>.</li>
        <li>Queries <b>Pinecone</b> for top-k similar chunks.</li>
        <li>Fetches conversation history from <b>DynamoDB</b>.</li>
        <li>Constructs prompt with retrieved context and history.</li>
        <li>Calls <b>Claude (Bedrock)</b> for answer generation.</li>
        <li>Stores updated conversation history in <b>DynamoDB</b>.</li>
      </ul>
    </div>
    <div class="step"><b>6. Response:</b> The answer is returned to the user via API Gateway.</div>
    <div class="step"><b>7. Monitoring & Security:</b> 
      <ul>
        <li>All Lambda logs and metrics are sent to <b>CloudWatch</b>.</li>
        <li><b>IAM Roles</b> restrict Lambda access to only required AWS services.</li>
        <li>All networking can be placed inside a <b>VPC</b> for private access if needed.</li>
      </ul>
    </div>

    <h2>Component Details</h2>
    <ul>
      <li><b>Amazon S3:</b> Stores raw documents and files for ingestion.</li>
      <li><b>Lambda Preprocessing:</b> Handles chunking, cleaning, embedding, and upserting to Pinecone.</li>
      <li><b>Pinecone:</b> Managed vector database for fast semantic search over document chunks.</li>
      <li><b>API Gateway:</b> Provides a secure HTTP endpoint for chat UI or API clients.</li>
      <li><b>Lambda Chatbot Handler:</b> Orchestrates embedding, retrieval, LLM prompt construction, and response.</li>
      <li><b>AWS Bedrock:</b> Provides access to Cohere for embeddings and Claude for LLM generation.</li>
      <li><b>DynamoDB:</b> Stores conversation history for multi-turn chat context.</li>
      <li><b>CloudWatch:</b> Collects logs and metrics for monitoring and troubleshooting.</li>
      <li><b>IAM Roles:</b> Securely grant Lambda functions access to only the AWS resources they need.</li>
      <li><b>VPC (Optional):</b> For private networking and enhanced security.</li>
    </ul>

    <div class="note">
      <b>Security & Best Practices:</b><br>
      - API keys and secrets are stored as Lambda environment variables.<br>
      - All third-party dependencies (like <code>pinecone</code>) are packaged as Lambda Layers.<br>
      - IAM roles restrict Lambda access to only required AWS services.<br>
      - CloudWatch is used for monitoring, alerting, and troubleshooting.<br>
      - VPC can be used for private networking if required.<br>
      - Pinecone region may differ from AWS region; slight latency is expected but acceptable for most use cases.
    </div>

    <h2>Deployment & Operations</h2>
    <ul>
      <li>All code is written in Python and deployed as Lambda functions.</li>
      <li>Preprocessing Lambda can be triggered manually or by S3 events.</li>
      <li>Chatbot Lambda is triggered by API Gateway, chat UI, or other event sources.</li>
      <li>Monitoring is done via AWS CloudWatch and Pinecone Console.</li>
      <li>Security is enforced via IAM and environment variables.</li>
      <li>Networking can be public or private (VPC) as needed.</li>
    </ul>

    <h2>Diagram Legend</h2>
    <ul>
      <li><span class="box" style="background:#ffe0e0;">S3 Bucket</span>: Document storage</li>
      <li><span class="box" style="background:#e0ffe0;">Lambda</span>: Preprocessing or Chatbot logic</li>
      <li><span class="box" style="background:#e0e7ff;">Pinecone</span>: Vector database</li>
      <li><span class="box" style="background:#e0ffe7;">Bedrock</span>: Embedding & LLM API</li>
      <li><span class="box" style="background:#e0f7ff;">DynamoDB</span>: Conversation history</li>
      <li><span class="box" style="background:#fffbe0;">User</span>: Chat UI or API client</li>
      <li><span class="box" style="background:#e0f7ff;">API Gateway</span>: HTTP endpoint for Lambda</li>
      <li><span class="box" style="background:#e0e0e0;">CloudWatch</span>: Logs & Metrics</li>
      <li><span class="box" style="background:#e0e0ff;">IAM Roles</span>: Lambda permissions</li>
      <li><span class="box" style="background:#e0ffe0;">VPC</span>: Private networking (optional)</li>
    </ul>
  </div>
</body>
</html>